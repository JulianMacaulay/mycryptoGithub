# 协整分析+参数优化系统使用说明文档

## 目录
1. [程序概述](#程序概述)
2. [环境要求](#环境要求)
3. [运行模式](#运行模式)
4. [普通回测模式详细流程](#普通回测模式详细流程)
5. [参数优化模式详细流程](#参数优化模式详细流程)
6. [参数说明](#参数说明)
7. [优化方法详解](#优化方法详解)
8. [输出结果说明](#输出结果说明)
9. [常见问题](#常见问题)

---

## 程序概述

本程序是一个完整的协整分析+交易策略回测+参数优化系统，主要功能包括：

1. **滚动窗口协整检验**：使用固定大小的滚动窗口进行协整关系检验
2. **协整对筛选**：识别具有稳定协整关系的币对
3. **交易策略回测**：基于协整关系的配对交易策略回测
4. **参数优化**：自动优化交易策略参数，包含过拟合检测

---

## 环境要求

### 必需库
```bash
pip install pandas numpy scipy statsmodels matplotlib
```

### 可选库（用于贝叶斯优化）
```bash
pip install scikit-optimize
```

**注意**：如果未安装 `scikit-optimize`，贝叶斯优化功能将不可用，但网格搜索和随机搜索仍可正常使用。

---

## 运行模式

程序启动后会提示选择运行模式：

```
请选择运行模式:
  1. 普通回测模式
  2. 参数优化模式
```

### 模式1：普通回测模式
- 手动配置交易参数
- 执行单次回测
- 支持多次测试不同参数组合
- 适合快速验证策略效果

### 模式2：参数优化模式
- 自动搜索最优参数组合
- 支持三种优化方法
- 包含过拟合检测
- 适合寻找最佳参数配置

---

## 普通回测模式详细流程

### 步骤1：加载数据

**输入**：
- CSV文件路径（可直接回车使用默认路径）

**处理**：
- 读取CSV文件
- 解析币对数据
- 按时间戳排序

**输出示例**：
```
正在加载CSV文件: segment_2_data_ccxt_20251113_103652.csv
数据形状: (10000, 5)
列名: ['timestamp', 'symbol', 'open', 'high', 'low', 'close', 'volume']
币对 BTCUSDT: 5000 条数据
币对 ETHUSDT: 5000 条数据
成功加载 2 个币对的数据
```

**注意事项**：
- CSV文件必须包含 `timestamp` 和 `close` 列
- 如果有 `symbol` 列，程序会按币对分组
- 时间戳会自动转换为 datetime 格式

---

### 步骤2：配置滚动窗口参数

**输入提示**：
```
滚动窗口参数配置
============================================================
当前默认参数:
  1. 窗口大小: 500 条数据
  2. 步长: 100 条数据

是否要修改参数？
输入 'y' 修改参数，直接回车使用默认参数
```

**参数说明**：
- **窗口大小**：每个滚动窗口包含的数据条数
  - 建议值：500-2000
  - 太小：协整检验可能不稳定
  - 太大：可能错过短期协整关系
  
- **步长**：窗口每次移动的数据条数
  - 建议值：50-200
  - 步长越小，窗口重叠越多，检验更细致但耗时更长

**输出示例**：
```
修改后的参数:
  1. 窗口大小: 1000 条数据
  2. 步长: 100 条数据
```

---

### 步骤3：滚动窗口寻找协整对

**处理过程**：
1. 对所有币对组合进行滚动窗口协整检验
2. 每个窗口内执行完整的EG两阶段协整检验：
   - 检验原序列的积分阶数
   - 计算最优对冲比率（OLS回归）
   - 检验价差的平稳性
3. 统计每个币对的协整窗口数量和比例

**输出示例**：
```
================================================================================
滚动窗口协整检验: BTCUSDT/ETHUSDT
窗口大小: 1000, 步长: 100
================================================================================
总数据点: 5000
窗口数量: 41

窗口 1/41:
  时间范围: 2024-01-01 00:00:00 到 2024-01-15 12:00:00
  数据点: 0 到 1000 (共 1000 条)
   协整检验通过 (P值: 0.023456)

汇总结果:
  总窗口数: 41
  协整窗口数: 28
  协整比例: 68.3%
```

**关键指标**：
- **协整比例**：协整窗口数 / 总窗口数
  - 比例越高，协整关系越稳定
  - 建议选择比例 ≥ 50% 的币对

---

### 步骤4：选择协整对

**输入提示**：
```
滚动窗口协整对候选列表
================================================================================
最小协整比例阈值: 50.0%

1. 币对: BTCUSDT/ETHUSDT
   总窗口数: 41
   协整窗口数: 28
   协整比例: 68.3%
   最佳窗口:
     时间范围: 2024-01-10 00:00:00 到 2024-01-25 12:00:00
     对冲比率: 0.062345
     价差ADF P值: 0.012345

请选择要使用的币对（输入序号，用逗号分隔，如: 1,3,5）
```

**选择方式**：
- 输入单个序号：`1`
- 输入多个序号（逗号分隔）：`1,3,5`
- 程序会自动选择每个币对的最佳窗口作为交易参数

**输出示例**：
```
已选择 2 个币对:
   - BTCUSDT/ETHUSDT (窗口: 2024-01-10 00:00:00 到 2024-01-25 12:00:00)
   - BTCUSDT/BNBUSDT (窗口: 2024-01-15 00:00:00 到 2024-01-30 12:00:00)
```

---

### 步骤5：币对测试循环

程序进入循环，允许多次测试不同参数组合。

**每次循环包含**：

#### 5.1 确认是否继续
```
是否继续测试？(y/n):
```

#### 5.2 显示选择的币对详情
```
第 1 次测试 - 选择的币对详情

币对: BTCUSDT/ETHUSDT
  窗口时间范围: 2024-01-10 00:00:00 到 2024-01-25 12:00:00
  积分阶数: BTCUSDT=I(1), ETHUSDT=I(1)
  对冲比率: 0.062345
  价差ADF P值: 0.012345
```

#### 5.3 配置交易参数

**输入提示**：
```
交易参数配置
============================================================
当前默认参数:
  1. 回看期: 60
  2. Z-score开仓阈值: 1.5
  3. Z-score平仓阈值: 0.6
  4. 止盈百分比: 15.0%
  5. 止损百分比: 8.0%
  6. 最大持仓时间: 168小时
  7. 仓位比例: 50.0% (留50.0%作为安全垫)
  8. 杠杆: 5倍

是否要修改参数？
```

**参数详细说明**（见[参数说明](#参数说明)章节）

#### 5.4 执行交易回测

**回测过程**：
1. 初始化策略实例
2. 遍历所有时间点
3. 对每个币对：
   - 计算当前价差和Z-score
   - 检查开仓/平仓条件
   - 执行交易并更新资金
4. 计算风险指标
5. 生成收益率曲线图
6. 导出交易记录

**输出示例**：
```
开始高级协整交易回测
============================================================
回测时间范围: 2024-01-01 00:00:00 到 2024-12-31 23:59:59
总数据点: 8760
选择的币对数量: 2
策略参数:
  初始资金: 10,000.00
  仓位比例: 50.0%
  杠杆: 5.0倍
  可用资金: 25,000.00 (留50.0%作为安全垫)
  Z-score开仓阈值: 1.5
  Z-score平仓阈值: 0.6
  止盈百分比: 15.0%
  止损百分比: 8.0%
  最大持仓时间: 168小时

开仓: BTCUSDT/ETHUSDT
   信号: Z-score过高(2.345)，做空价差
   价格: BTCUSDT=45000.00, ETHUSDT=2800.00
   价差: 123.456789
   仓位: BTCUSDT=-0.123456, ETHUSDT=0.007654
   使用资金: 12500.00 / 25000.00

平仓: BTCUSDT/ETHUSDT
   平仓原因: Z-score回归到0.234，平仓获利
   盈亏: 1234.56
   持仓时间: 48.5小时
   平仓价格: BTCUSDT=44800.00, ETHUSDT=2810.00
   价差变化: 123.456789 -> 98.765432 (变化: -24.691357)

回测结果:
  初始资金: 10,000.00
  最终资金: 12,345.67
  总收益率: 23.46%
  总交易次数: 25
  盈利交易: 18
  胜率: 72.0%

风险指标:
  最大回撤: 1,234.56
  最大回撤百分比: 12.35%
  盈亏比: 1.85
  夏普比率: 1.23
  平均盈利: 234.56
  平均亏损: -126.78
```

#### 5.5 显示交易详情

按币对分组显示所有交易记录。

---

## 参数优化模式详细流程

### 步骤1-4：与普通回测模式相同

步骤1-4（加载数据、配置滚动窗口参数、寻找协整对、选择协整对）与普通回测模式完全相同。

---

### 步骤5：选择优化方法

**输入提示**：
```
5. 选择优化方法
可选方法:
  1. 网格搜索（粗粒度+细粒度）
  2. 随机搜索
  3. 贝叶斯优化

请选择优化方法 (1/2/3):
```

**方法选择建议**：
- **网格搜索**：适合参数空间较小，需要全面搜索
- **随机搜索**：适合参数空间较大，快速找到较好参数
- **贝叶斯优化**：适合参数空间大，需要高效搜索（需要安装scikit-optimize）

---

### 步骤6：选择优化目标

**输入提示**：
```
6. 选择优化目标
可选目标:
  1. 夏普比率 (sharpe_ratio)
  2. 总收益率 (return)
  3. 收益率/回撤比 (return_drawdown_ratio)

请选择优化目标 (1/2/3):
```

**目标说明**：
- **夏普比率**：风险调整后的收益，综合考虑收益和波动
- **总收益率**：单纯追求最高收益
- **收益率/回撤比**：平衡收益和风险，适合稳健策略

---

### 步骤7：创建优化器

程序自动创建优化器实例，配置：
- 数据：加载的价格数据
- 协整对：选择的币对
- 初始资金：10000
- 优化目标：用户选择的目标
- 稳定性测试：启用

---

### 步骤8：执行优化

根据选择的优化方法执行不同的优化流程。

#### 8.1 网格搜索优化

**第一阶段：粗粒度搜索**

```
第一阶段：粗粒度网格搜索
--------------------------------------------------------------------------------
测试 100 个粗粒度参数组合...
  进度: 10/100 (10.0%), 当前最佳得分: 0.0000
  ✓ 找到更好的参数组合 #5: 得分=1.2345
  进度: 20/100 (20.0%), 当前最佳得分: 1.2345
  ...
粗粒度搜索完成，最佳得分: 2.3456
```

**第二阶段：细粒度搜索**

```
第二阶段：细粒度网格搜索（在最佳参数附近）
--------------------------------------------------------------------------------
测试 200 个细粒度参数组合...
  进度: 20/200 (10.0%), 当前最佳得分: 2.3456
  ✓ 找到更好的参数组合 #45: 得分=2.4567
  ...
细粒度搜索完成，最终最佳得分: 2.4567
```

**参数稳定性测试**：
```
进行参数稳定性测试（过拟合检测）...
✓ 参数稳定性良好 (CV=0.123, 下降比例=0.045)
```

#### 8.2 随机搜索优化

**输入**：
```
请输入随机搜索迭代次数 (默认100):
```

**执行过程**：
```
开始随机搜索优化
================================================================================
迭代次数: 100
  进度: 10/100 (10.0%), 当前最佳得分: 0.0000
  ✓ 迭代 15/100: 找到更好的参数，得分=1.2345
  进度: 20/100 (20.0%), 当前最佳得分: 1.2345
  ...
```

#### 8.3 贝叶斯优化

**输入**：
```
请输入贝叶斯优化评估次数 (默认50):
```

**执行过程**：
```
开始贝叶斯优化
================================================================================
评估次数: 50
[自动执行贝叶斯优化，显示最终结果]
```

**注意**：如果未安装scikit-optimize，会提示错误。

---

### 步骤9：显示优化结果

**输出内容**：

```
优化结果
================================================================================

最佳参数:
  lookback_period: 90
  z_threshold: 2.0
  z_exit_threshold: 0.5
  take_profit_pct: 0.15
  stop_loss_pct: 0.08
  max_holding_hours: 168
  position_ratio: 0.5
  leverage: 5

最佳得分: 2.4567
  总收益率: 23.45%
  夏普比率: 2.4567
  最大回撤: 8.90%
  盈亏比: 1.85
  总交易次数: 25

稳定性测试:
  稳定性: 良好
  变异系数: 0.123
  得分下降比例: 0.045

总评估次数: 300
```

**关键指标解读**：
- **最佳得分**：根据选择的优化目标计算的得分
- **稳定性**：参数对扰动的敏感度
  - **良好**：CV < 0.3 且下降比例 < 0.2
  - **可能不稳定**：需要谨慎使用

---

### 步骤10：显示前10个最佳结果

```
前10个最佳参数组合:

1. 得分=2.4567, 收益率=23.45%, 夏普=2.4567
   参数: {'lookback_period': 90, 'z_threshold': 2.0, ...}

2. 得分=2.3456, 收益率=22.34%, 夏普=2.3456
   参数: {'lookback_period': 80, 'z_threshold': 1.8, ...}
...
```

---

### 步骤11：导出优化结果

自动导出所有评估结果到CSV文件：

```
11. 导出优化结果...
优化结果已导出到: optimization_results_20241113_143025.csv
```

**CSV文件包含**：
- 所有参数组合
- 对应的得分和各项指标
- 按得分降序排列

---

## 参数说明

### 滚动窗口参数

| 参数 | 默认值 | 说明 | 建议范围 |
|------|--------|------|----------|
| 窗口大小 | 500 | 每个窗口的数据条数 | 500-2000 |
| 步长 | 100 | 窗口移动的步长 | 50-200 |

### 交易策略参数

| 参数 | 默认值 | 说明 | 建议范围 |
|------|--------|------|----------|
| 回看期 | 60 | 计算Z-score的历史数据长度 | 30-120 |
| Z-score开仓阈值 | 1.5 | 价差偏离均值多少倍时开仓 | 1.0-3.0 |
| Z-score平仓阈值 | 0.6 | 价差回归到多少倍时平仓 | 0.3-1.0 |
| 止盈百分比 | 15% | 盈利达到多少百分比时止盈 | 5%-25% |
| 止损百分比 | 8% | 亏损达到多少百分比时止损 | 5%-15% |
| 最大持仓时间 | 168小时 | 持仓超过此时长强制平仓 | 72-720小时 |
| 仓位比例 | 50% | 使用多少比例的资金 | 30%-90% |
| 杠杆 | 5倍 | 使用的杠杆倍数 | 1-20倍 |

### 参数优化空间

程序预定义了以下参数搜索空间：

**粗粒度搜索空间**：
- `lookback_period`: [30, 60, 90, 120]
- `z_threshold`: [1.0, 1.5, 2.0, 2.5, 3.0]
- `z_exit_threshold`: [0.3, 0.5, 0.7, 0.9]
- `take_profit_pct`: [0.05, 0.10, 0.15, 0.20, 0.25]
- `stop_loss_pct`: [0.05, 0.08, 0.10, 0.12, 0.15]
- `max_holding_hours`: [72, 120, 168, 240]
- `position_ratio`: [0.3, 0.5, 0.7, 0.9]
- `leverage`: [1, 3, 5, 10]

**细粒度搜索**：在最佳参数附近按步长搜索

---

## 优化方法详解

### 1. 网格搜索（Grid Search）

**原理**：
- 在预定义的参数网格上穷举所有组合
- 分层搜索：先粗粒度，再细粒度

**优点**：
- 全面搜索，不会遗漏最优解
- 结果可重现

**缺点**：
- 计算量大，耗时长
- 参数空间大时不可行

**适用场景**：
- 参数数量少（< 5个）
- 需要全面搜索
- 计算资源充足

**执行流程**：
1. 粗粒度搜索：测试所有粗粒度组合（最多100个）
2. 细粒度搜索：在最佳参数附近精细搜索（最多200个）
3. 稳定性测试：检测参数稳定性

---

### 2. 随机搜索（Random Search）

**原理**：
- 在参数空间中随机采样
- 不保证找到全局最优，但通常能找到较好解

**优点**：
- 计算量可控
- 适合高维参数空间
- 可能发现意外的参数组合

**缺点**：
- 不保证最优
- 结果不可重现（除非固定随机种子）

**适用场景**：
- 参数数量多（> 5个）
- 需要快速找到较好参数
- 计算资源有限

**执行流程**：
1. 随机生成参数组合（默认100次迭代）
2. 评估每个组合
3. 记录最佳结果
4. 稳定性测试

---

### 3. 贝叶斯优化（Bayesian Optimization）

**原理**：
- 使用高斯过程建模目标函数
- 智能选择下一个评估点
- 平衡探索和利用

**优点**：
- 高效，通常用较少评估找到较好解
- 适合昂贵的目标函数（如回测）

**缺点**：
- 需要安装scikit-optimize
- 对参数空间有要求

**适用场景**：
- 参数数量中等（3-8个）
- 目标函数计算昂贵
- 需要高效优化

**执行流程**：
1. 初始化：随机评估几个点
2. 建模：用高斯过程建模目标函数
3. 选择：用采集函数选择下一个评估点
4. 评估：评估新点并更新模型
5. 重复步骤3-4直到达到评估次数
6. 稳定性测试

---

## 过拟合检测机制

### 原理

在最佳参数附近生成扰动，检查结果是否稳定：

1. **生成扰动参数**：对每个参数添加小幅度随机扰动
2. **评估扰动参数**：对扰动后的参数进行回测
3. **计算稳定性指标**：
   - **变异系数（CV）**：扰动后得分的标准差/均值
   - **得分下降比例**：扰动后平均得分相对于原始得分的下降比例

### 判断标准

参数被认为是**稳定**的，当且仅当：
- CV < 0.3（得分波动小）
- 得分下降比例 < 0.2（对扰动不敏感）

### 输出示例

```
稳定性测试:
  稳定性: 良好
  变异系数: 0.123
  得分下降比例: 0.045
```

**解读**：
- **良好**：参数稳定，可以放心使用
- **可能不稳定**：参数对扰动敏感，可能存在过拟合，建议：
  - 增加训练数据
  - 简化模型
  - 使用更保守的参数

---

## 输出结果说明

### 回测结果指标

| 指标 | 说明 | 计算公式 |
|------|------|----------|
| 总收益率 | 最终资金相对于初始资金的增长 | (最终资金 - 初始资金) / 初始资金 × 100% |
| 最大回撤 | 资金曲线从峰值到谷值的最大跌幅 | max(峰值 - 谷值) |
| 最大回撤百分比 | 最大回撤相对于峰值的比例 | 最大回撤 / 峰值 × 100% |
| 夏普比率 | 风险调整后的收益 | 平均收益率 / 收益率标准差 × √252 |
| 盈亏比 | 平均盈利 / 平均亏损 | avg(盈利交易) / abs(avg(亏损交易)) |
| 胜率 | 盈利交易占比 | 盈利交易数 / 总交易数 × 100% |

### 优化结果文件

导出的CSV文件包含以下列：

- 所有参数列（lookback_period, z_threshold, ...）
- `score`: 优化目标得分
- `total_return`: 总收益率
- `sharpe_ratio`: 夏普比率
- `max_drawdown_pct`: 最大回撤百分比
- `profit_loss_ratio`: 盈亏比
- `total_trades`: 总交易次数
- `profitable_trades`: 盈利交易次数

文件按得分降序排列，便于分析。

---

## 常见问题

### Q1: 程序运行很慢怎么办？

**A**: 
- 减少滚动窗口数量（增大步长）
- 减少优化迭代次数
- 使用随机搜索而非网格搜索
- 减少数据量

### Q2: 找不到协整对怎么办？

**A**:
- 检查数据质量
- 调整滚动窗口参数（增大窗口大小）
- 降低协整比例阈值
- 检查币对是否真的存在协整关系

### Q3: 优化结果不稳定怎么办？

**A**:
- 增加训练数据量
- 使用更保守的参数范围
- 选择稳定性测试通过的参数
- 考虑使用集成方法（多个稳定参数组合的平均）

### Q4: 贝叶斯优化报错？

**A**:
- 安装scikit-optimize: `pip install scikit-optimize`
- 如果仍报错，使用网格搜索或随机搜索

### Q5: 如何选择合适的优化目标？

**A**:
- **追求稳健**：选择夏普比率
- **追求收益**：选择总收益率
- **平衡收益风险**：选择收益率/回撤比

### Q6: 参数优化需要多长时间？

**A**:
- 网格搜索：取决于参数组合数，通常10分钟-2小时
- 随机搜索：取决于迭代次数，通常5-30分钟
- 贝叶斯优化：取决于评估次数，通常10-60分钟

### Q7: 如何理解稳定性测试结果？

**A**:
- **CV < 0.3 且下降比例 < 0.2**：参数稳定，可放心使用
- **CV > 0.3 或下降比例 > 0.2**：参数可能不稳定，建议：
  - 重新优化
  - 使用更保守的参数
  - 增加数据量

---

## 使用建议

### 初次使用

1. 先用**普通回测模式**熟悉流程
2. 手动调整参数，观察效果
3. 找到大致合理的参数范围

### 参数优化

1. 先用**随机搜索**快速找到较好参数
2. 再用**网格搜索**在较好参数附近精细搜索
3. 检查稳定性测试结果
4. 选择稳定性良好的参数

### 生产使用

1. 使用优化后的参数
2. 定期重新优化（如每月）
3. 监控实际表现
4. 如果表现下降，重新优化

---

## 技术支持

如有问题，请检查：
1. 数据格式是否正确
2. 依赖库是否安装完整
3. 参数设置是否合理
4. 查看错误信息定位问题

---

**文档版本**: 1.0  
**最后更新**: 2024-11-13

