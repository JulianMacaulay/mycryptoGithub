# 协整币对筛选流程说明文档

## 一、概述

`cointegration_stable_pairs_screening.py` 是一个用于筛选稳定协整币对的工具。该工具通过样本内数据筛选和样本外数据验证，找出在不同时间窗口下都保持协整关系的稳定币对。

### 主要功能

1. **样本内数据筛选**：使用样本内数据筛选协整比率较高且对冲比率合理的币对
2. **样本外数据验证**：使用样本外数据验证筛选出的币对
3. **交集计算**：找出在样本内和样本外都通过检验的稳定协整币对
4. **多窗口参数测试**：支持多个窗口参数组合的测试，提高筛选的稳健性

## 二、核心概念

### 2.1 协整关系

协整关系是指两个非平稳时间序列之间存在长期均衡关系。如果两个I(1)序列的线性组合是平稳的（I(0)），则这两个序列存在协整关系。

### 2.2 对冲比率（Hedge Ratio）

对冲比率是通过OLS回归计算得出的，表示为了对冲一个币种的价格风险，需要持有多少单位的另一个币种。

计算公式：`price1 = α + β * price2 + ε`

其中，β 就是对冲比率。

### 2.3 协整比率（Cointegration Ratio）

协整比率是指在滚动窗口检验中，通过协整检验的窗口数量占总窗口数量的比例。这个比率越高，说明币对的协整关系越稳定。

## 三、筛选流程

### 3.1 整体流程

```
加载数据
    ↓
对每个窗口参数组合：
    ├─ 步骤1: 样本内数据筛选
    │   ├─ 滚动窗口协整检验
    │   └─ 根据条件筛选币对
    │
    ├─ 步骤2: 样本外数据验证
    │   ├─ 对样本内筛选出的币对进行验证
    │   └─ 筛选通过验证的币对
    │
    └─ 步骤3: 计算交集
        └─ 找出样本内筛选且样本外验证通过的币对
    ↓
汇总所有窗口参数组合的结果
```

### 3.2 详细步骤

#### 步骤1：数据加载

- **函数**：`load_csv_data()`
- **功能**：从CSV文件加载币对价格数据
- **输入**：CSV文件路径（包含timestamp、symbol、close等列）
- **输出**：字典格式，键为币对名称，值为价格序列

#### 步骤2：滚动窗口协整检验

对每个币对组合，使用滚动窗口进行协整检验：

1. **确定积分阶数**（`determine_integration_order()`）
   - 检验原序列是否为I(0)（平稳）
   - 如果不是，检验一阶差分是否为I(0)
   - 如果还不是，检验二阶差分是否为I(0)
   - 只有两个序列都是I(1)时，才能进行协整检验

2. **计算对冲比率**（`calculate_hedge_ratio()`）
   - 使用OLS回归计算最优对冲比率
   - 根据`diff_order`参数选择使用原始价格或一阶差分价格

3. **计算价差**（`enhanced_cointegration_test()`）
   - 如果`diff_order=0`：价差 = price1 - hedge_ratio × price2
   - 如果`diff_order=1`：价差 = diff(price1) - hedge_ratio × diff(price2)

4. **ADF检验**（`advanced_adf_test()`）
   - 对价差序列进行ADF检验
   - 如果P值 < 0.05，认为价差平稳，协整关系成立

5. **滚动窗口统计**
   - 统计所有窗口中通过协整检验的窗口数量
   - 计算协整比率 = 协整窗口数 / 总窗口数

#### 步骤3：币对筛选

- **函数**：`filter_pairs_by_criteria()`
- **筛选条件**：
  1. **最小协整比率**（`min_cointegration_ratio`，默认0.2）
     - 协整比率 >= 最小协整比率
     - 例如：0.2 表示至少20%的窗口通过协整检验
   
  2. **最大对冲比率**（`max_hedge_ratio`，默认100.0）
     - 平均对冲比率的绝对值 <= 最大对冲比率
     - 用于过滤掉对冲比率过大（不实用）的币对

#### 步骤4：样本外验证

对样本内筛选出的币对，使用样本外数据进行验证：

1. 检查样本外数据中是否包含该币对
2. 对样本外数据执行相同的滚动窗口协整检验
3. 使用相同的筛选条件进行筛选
4. 只保留在样本外也通过检验的币对

#### 步骤5：计算交集

交集 = 样本内筛选出的币对 ∩ 样本外验证通过的币对

这些币对在样本内和样本外都表现出稳定的协整关系，是最可靠的交易对。

#### 步骤6：多窗口参数组合测试

工具支持多个窗口参数组合的测试：

- **窗口大小**（`window_size`）：每个窗口包含的数据条数
- **步长**（`step_size`）：窗口每次移动的数据条数

默认窗口参数组合：
- (500, 100)
- (720, 120)
- (240, 120)
- (200, 50)
- (1000, 500)

最终汇总所有窗口参数组合下的稳定币对，找出在不同参数下都表现稳定的币对。

## 四、关键函数说明

### 4.1 数据加载函数

```python
load_csv_data(csv_file_path)
```
- 从CSV文件加载数据
- 支持多币对数据（通过symbol列分组）
- 返回字典格式：{币对名称: 价格序列}

### 4.2 协整检验函数

```python
enhanced_cointegration_test(price1, price2, symbol1, symbol2, verbose=True, diff_order=0)
```
- 执行完整的协整检验流程
- 包括积分阶数检验、对冲比率计算、价差计算、ADF检验
- 返回检验结果字典

### 4.3 滚动窗口检验函数

```python
rolling_window_cointegration_test(price1, price2, symbol1, symbol2, 
                                   window_size=500, step_size=100, 
                                   diff_order=0, verbose=False)
```
- 对币对进行滚动窗口协整检验
- 统计协整窗口数量和协整比率
- 返回汇总结果

### 4.4 筛选函数

```python
filter_pairs_by_criteria(summaries, min_cointegration_ratio=0.2, max_hedge_ratio=100.0)
```
- 根据协整比率和对冲比率筛选币对
- 返回筛选后的币对列表

### 4.5 主筛选函数

```python
screen_stable_cointegrated_pairs(in_sample_file, out_sample_file, 
                                  window_params_list, 
                                  min_cointegration_ratio=0.2, 
                                  max_hedge_ratio=100.0, 
                                  diff_order=0, verbose=True)
```
- 执行完整的筛选流程
- 包括样本内筛选、样本外验证、交集计算
- 支持多窗口参数组合测试
- 返回所有结果

## 五、参数说明

### 5.1 输入参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `in_sample_file` | str | - | 样本内数据文件路径 |
| `out_sample_file` | str | - | 样本外数据文件路径 |
| `window_params_list` | list | - | 窗口参数列表，格式：[(window_size, step_size), ...] |
| `min_cointegration_ratio` | float | 0.2 | 最小协整比率（0-1之间） |
| `max_hedge_ratio` | float | 100.0 | 最大对冲比率（绝对值） |
| `diff_order` | int | 0 | 价差类型：0=原始价差，1=一阶差分价差 |
| `verbose` | bool | True | 是否显示详细信息 |

### 5.2 窗口参数

- **window_size**：窗口大小，表示每个窗口包含的数据条数
  - 较大的窗口：更稳定，但可能错过短期协整关系
  - 较小的窗口：更敏感，但可能产生更多噪音

- **step_size**：步长，表示窗口每次移动的数据条数
  - 较大的步长：计算更快，但可能遗漏一些窗口
  - 较小的步长：更全面，但计算时间更长

### 5.3 筛选条件

- **min_cointegration_ratio**：最小协整比率
  - 例如：0.2 表示至少20%的窗口通过协整检验
  - 建议值：0.2-0.5

- **max_hedge_ratio**：最大对冲比率
  - 过滤掉对冲比率过大（不实用）的币对
  - 建议值：10-100

## 六、输出结果

### 6.1 结果结构

函数返回一个字典，包含以下内容：

```python
{
    'all_results': {
        (window_size, step_size): {
            'in_sample_filtered': [...],      # 样本内筛选结果
            'out_sample_filtered': [...],     # 样本外验证结果
            'intersection': [...]             # 交集结果
        },
        ...
    },
    'all_intersection_pairs': {
        '币对名称': [
            {
                'window_size': ...,
                'step_size': ...,
                'pair_info': {...}
            },
            ...
        ],
        ...
    },
    'window_params_list': [...],
    'min_cointegration_ratio': ...,
    'max_hedge_ratio': ...,
    'diff_order': ...
}
```

### 6.2 币对信息

每个筛选出的币对包含以下信息：

- `pair_name`：币对名称（格式：symbol1/symbol2）
- `symbol1`：第一个币种
- `symbol2`：第二个币种
- `cointegration_ratio`：协整比率
- `hedge_ratio`：平均对冲比率
- `abs_hedge_ratio`：平均对冲比率绝对值
- `total_windows`：总窗口数
- `cointegration_windows`：协整窗口数
- `window_size`：窗口大小
- `step_size`：步长
- `diff_order`：价差类型

对于样本外验证通过的币对，还包含：
- `in_sample_cointegration_ratio`：样本内协整比率
- `in_sample_hedge_ratio`：样本内对冲比率
- `out_sample_cointegration_ratio`：样本外协整比率
- `out_sample_hedge_ratio`：样本外对冲比率

## 七、使用示例

### 7.1 基本使用

```python
from cointegration_stable_pairs_screening import screen_stable_cointegrated_pairs

# 定义窗口参数组合
window_params_list = [
    (500, 100),
    (720, 120),
    (240, 120)
]

# 执行筛选
results = screen_stable_cointegrated_pairs(
    in_sample_file="1h_4000_样本内_28.csv",
    out_sample_file="1h_1000_样本外_28.csv",
    window_params_list=window_params_list,
    min_cointegration_ratio=0.2,
    max_hedge_ratio=100.0,
    diff_order=0,
    verbose=True
)
```

### 7.2 查看结果

```python
# 查看所有窗口参数组合的交集
for pair_name, occurrences in results['all_intersection_pairs'].items():
    print(f"\n币对: {pair_name}")
    print(f"出现的窗口参数组合数: {len(occurrences)}")
    for occ in occurrences:
        pair_info = occ['pair_info']
        print(f"  窗口参数: window_size={occ['window_size']}, step_size={occ['step_size']}")
        print(f"    样本内协整比率: {pair_info['in_sample_cointegration_ratio']:.2%}")
        print(f"    样本外协整比率: {pair_info['out_sample_cointegration_ratio']:.2%}")
```

## 八、注意事项

1. **数据要求**：
   - CSV文件必须包含timestamp、symbol、close列
   - 数据应该是连续的时间序列
   - 建议样本内数据量 >= 2000条，样本外数据量 >= 500条

2. **参数选择**：
   - 窗口大小应该根据数据频率选择（如1小时数据，500条约等于20天）
   - 步长建议为窗口大小的1/5到1/10
   - 最小协整比率建议在0.2-0.5之间

3. **计算时间**：
   - 币对数量较多时，计算时间可能较长
   - 可以通过设置`verbose=False`减少输出，加快速度
   - 可以通过减少窗口参数组合数量来加快速度

4. **结果解释**：
   - 协整比率越高，币对越稳定
   - 对冲比率应该在合理范围内（通常0.1-10之间）
   - 在多个窗口参数组合下都出现的币对更可靠

## 九、技术细节

### 9.1 协整检验方法

使用Engle-Granger两步法：

1. 使用OLS回归计算对冲比率
2. 计算残差（价差）
3. 对残差进行ADF检验
4. 如果残差平稳（P值 < 0.05），则协整关系成立

### 9.2 积分阶数检验

- I(0)：平稳序列
- I(1)：一阶单整序列（一阶差分后平稳）
- I(2)：二阶单整序列（二阶差分后平稳）

只有两个序列都是I(1)时，才能进行协整检验。

### 9.3 价差类型

- **原始价差**（`diff_order=0`）：
  - 价差 = price1 - hedge_ratio × price2
  - 适用于大多数情况

- **一阶差分价差**（`diff_order=1`）：
  - 价差 = diff(price1) - hedge_ratio × diff(price2)
  - 适用于价格序列存在趋势的情况

## 十、总结

该工具通过严格的统计检验和样本外验证，筛选出在不同时间窗口下都保持稳定协整关系的币对。这些币对适合用于统计套利策略，因为它们具有：

1. **稳定性**：在样本内和样本外都表现出协整关系
2. **稳健性**：在多个窗口参数组合下都通过检验
3. **实用性**：对冲比率在合理范围内，便于实际交易

通过使用该工具，可以大大提高统计套利策略的成功率和稳定性。

